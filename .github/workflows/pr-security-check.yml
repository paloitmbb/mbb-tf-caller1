# ============================================================================
# PR Security Check - Validation & Security Scanning with Plan Preview
# ============================================================================
#
# Purpose: Validates Terraform code and runs security scans on pull requests
#          with plan preview generation using Azure OIDC authentication.
#
# Triggers:
#   - pull_request: main/develop branches with Terraform file changes
#   - workflow_dispatch: manual execution with configurable inputs
#
# Job Flow:
#   1. PREPARE â†’ Detect environment from changed file paths
#   2. VALIDATE-AND-SCAN â†’ Run validation & security scans (terraform-security.yml)
#   3. COMMENT-PR â†’ Post comprehensive results to PR
#
# Architecture: Two-stage workflow pattern
#   - Stage 1 (This workflow): Security validation with plan preview
#   - Stage 2 (terraform-ci.yml): Full CI with signed artifacts post-merge
#
# Key Features:
#   - Azure OIDC authentication (zero static credentials)
#   - Parallel security scanning (tfsec, Checkov, Trivy)
#   - Plan preview generation for PR reviews
#   - SARIF upload to GitHub Security tab
#   - PR comments with security findings
#   - Fast execution (~4-6 minutes)
#
# Azure OIDC Setup:
#   Federated credential must trust these branches:
#   - main
#   - feature/test-pr-security
# ============================================================================

name: PR Security Check

on:
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'env/**'
      - 'modules/**'
      - '**.tf'
      - '**.tfvars'
  
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to scan'
        required: true
        type: choice
        options:
          - dev
          - stage
          - prod
        default: 'dev'
      tfsec-severity:
        description: 'tfsec minimum severity to fail on'
        required: false
        type: choice
        options:
          - LOW
          - MEDIUM
          - HIGH
          - CRITICAL
        default: 'CRITICAL'
      checkov-severity:
        description: 'Checkov minimum severity to fail on'
        required: false
        type: choice
        options:
          - LOW
          - MEDIUM
          - HIGH
          - CRITICAL
        default: 'HIGH'
      trivy-severity:
        description: 'Trivy minimum severity to fail on'
        required: false
        type: choice
        options:
          - LOW
          - MEDIUM
          - HIGH
          - CRITICAL
        default: 'HIGH'

# Prevent concurrent runs for the same PR
concurrency:
  group: pr-security-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

# Minimal permissions (principle of least privilege)
permissions:
  contents: read
  pull-requests: write

jobs:
  # ==========================================================================
  # Job 1: PREPARE - Environment Detection
  # ==========================================================================
  prepare:
    name: Detect Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.env.outputs.environment }}
      working-directory: ${{ steps.env.outputs.working-directory }}
      changed-paths: ${{ steps.env.outputs.changed-paths }}
      detection-method: ${{ steps.env.outputs.detection-method }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
        with:
          fetch-depth: 0  # Required for path filtering
      
      - name: Detect Environment
        id: env
        uses: paloitmbb/mbb-tf-actions/actions/determine-environment@main
        with:
          manual-environment: ${{ inputs.environment || '' }}
          base-ref: ${{ github.base_ref || 'main' }}
      
      - name: Display Detection Results
        run: |
          echo "ğŸ” Environment Detection Results"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Environment: ${{ steps.env.outputs.environment }}"
          echo "Working Directory: ${{ steps.env.outputs.working-directory }}"
          echo "Detection Method: ${{ steps.env.outputs.detection-method }}"
          echo "Changed Paths: ${{ steps.env.outputs.changed-paths }}"

  # ==========================================================================
  # Job 2: VALIDATE-AND-SCAN - Security Validation (terraform-security.yml)
  # ==========================================================================
  validate-and-scan:
    name: Validate & Scan (${{ needs.prepare.outputs.environment }})
    needs: prepare
    permissions:
      contents: read
      security-events: write
      actions: read
      id-token: write       # Required for Azure OIDC authentication (plan preview)
    uses: paloitmbb/mbb-tf-workflows/.github/workflows/terraform-security.yml@main
    with:
      terraform-version: '1.7.0'
      working-directory: ${{ needs.prepare.outputs.working-directory }}
      environment: ${{ needs.prepare.outputs.environment }}
      
      # Code Quality Linting
      enable-tflint: true
      tflint-version: 'v0.60.0'
      
      # Enable all security scanners
      enable-tfsec: true
      enable-checkov: true
      enable-trivy: true
      
      # Configure severity thresholds
      tfsec-severity: ${{ inputs.tfsec-severity || 'CRITICAL' }}
      checkov-severity: ${{ inputs.checkov-severity || 'HIGH' }}
      trivy-severity: ${{ inputs.trivy-severity || 'HIGH' }}
      
      # Continue-on-error Control (allow all scans to run for comprehensive reporting)
      tfsec-continue-on-error: true
      checkov-continue-on-error: true
      trivy-continue-on-error: true
      aggregate-continue-on-error: false  # Fail workflow if security issues detected
      
      # Terraform configuration
      terraform-var-file: 'terraform.tfvars'
      runner-os: 'ubuntu-latest'
    
    secrets:
      # Azure OIDC Authentication for plan generation
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}


  # ==========================================================================
  # Job 3: COMMENT-PR - PR Communication
  # ==========================================================================
  comment-pr:
    name: Comment Security Results
    needs: [prepare, validate-and-scan]
    runs-on: ubuntu-latest
    if: always() && github.event_name == 'pull_request'
    permissions:
      pull-requests: write
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
      
      - name: Post Security Summary
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            // Helper functions
            const getStatusEmoji = (status) => {
              if (status === 'success') return 'âœ…';
              if (status === 'failure') return 'âŒ';
              return 'â­ï¸';
            };
            
            const getStatusText = (status) => {
              if (status === 'success') return 'Passed';
              if (status === 'failure') return 'Failed';
              return 'Skipped';
            };
            
            // Get job results
            const allPassed = '${{ needs.validate-and-scan.outputs.security-all-passed }}';
            const tfsecStatus = '${{ needs.validate-and-scan.outputs.tfsec-status }}';
            const checkovStatus = '${{ needs.validate-and-scan.outputs.checkov-status }}';
            const trivyStatus = '${{ needs.validate-and-scan.outputs.trivy-status }}';
            const tflintStatus = '${{ needs.validate-and-scan.outputs.tflint-status }}';
            const tfVersion = '${{ needs.validate-and-scan.outputs.terraform-version }}';
            
            // Environment detection results
            const environment = '${{ needs.prepare.outputs.environment }}';
            const workingDir = '${{ needs.prepare.outputs.working-directory }}';
            const detectionMethod = '${{ needs.prepare.outputs.detection-method }}';
            const changedPaths = '${{ needs.prepare.outputs.changed-paths }}';
            
            // Scanner severity thresholds
            const tfsecSeverity = '${{ inputs.tfsec-severity || 'CRITICAL' }}';
            const checkovSeverity = '${{ inputs.checkov-severity || 'HIGH' }}';
            const trivySeverity = '${{ inputs.trivy-severity || 'HIGH' }}';
            
            // Overall status
            const overallStatus = allPassed === 'true' ? 'âœ… PASSED' : 'âŒ FAILED';
            const overallEmoji = allPassed === 'true' ? 'ğŸ‰' : 'âš ï¸';
            
            // Build PR comment
            const body = `## ğŸ”’ PR Security Validation Results
            
            ${overallEmoji} **Overall Status: ${overallStatus}**
            
            ---
            
            ### ğŸ“‹ Environment & Configuration
            
            | Item | Value |
            |------|-------|
            | **Environment** | \`${environment}\` |
            | **Working Directory** | \`${workingDir}\` |
            | **Detection Method** | ${detectionMethod} |
            | **Terraform Version** | ${tfVersion} |
            
            ${changedPaths ? `**Changed Paths**: \`${changedPaths}\`` : ''}
            
            ---
            
            ### âœ… Validation Results
            
            | Check | Status |
            |-------|--------|
            | **Code Quality (tflint)** | ${getStatusEmoji(tflintStatus)} ${getStatusText(tflintStatus)} |
            
            > **Note**: Full validation results (fmt, validate, tflint) are available in the workflow logs.
            
            ---
            
            ### ğŸ”’ Security Scan Results
            
            | Tool | Status | Severity Threshold |
            |------|--------|-------------------|
            | ğŸ” **tfsec** | ${getStatusEmoji(tfsecStatus)} ${getStatusText(tfsecStatus)} | \`${tfsecSeverity}\` |
            | ğŸ›¡ï¸ **Checkov** | ${getStatusEmoji(checkovStatus)} ${getStatusText(checkovStatus)} | \`${checkovSeverity}\` |
            | ğŸ” **Trivy** | ${getStatusEmoji(trivyStatus)} ${getStatusText(trivyStatus)} | \`${trivySeverity}\` |
            
            ${allPassed === 'true' 
              ? 'âœ… **All security checks passed!** This PR meets security requirements.' 
              : 'âŒ **Security issues detected!** Please review and fix before merging.'}`;
            
            // Post comment
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
            
            console.log('âœ… PR comment posted successfully');
