# ============================================================================
# PR Security Check - Lightweight Validation & Security Scanning
# ============================================================================
#
# Purpose: Validates Terraform code and runs security scans on pull requests
#          with plan preview generation using Azure OIDC authentication.
#
# Triggers:
#   - pull_request: main/develop branches with Terraform file changes
#   - workflow_dispatch: manual execution with configurable inputs
#
# Job Flow:
#   1. PREPARE â†’ Detect environment from changed file paths
#   2. VALIDATE-AND-SCAN â†’ Run validation & security scans (terraform-security.yml)
#   3. SECURITY-GATE â†’ Evaluate results (configurable blocking)
#   4. COMMENT-PR â†’ Post comprehensive results to PR
#
# Architecture: Two-stage workflow pattern
#   - Stage 1 (This workflow): Security validation with plan preview
#   - Stage 2 (terraform-ci.yml): Full CI with signed artifacts post-merge
#
# Key Features:
#   - Azure OIDC authentication (zero static credentials)
#   - Parallel security scanning (tfsec, Checkov, Trivy)
#   - Plan preview generation for PR reviews
#   - SARIF upload to GitHub Security tab
#   - Configurable security gate (blocking vs. reporting mode)
#   - Fast execution (~4-6 minutes)
#
# Azure OIDC Setup:
#   Federated credential must trust these branches:
#   - main
#   - feature/test-pr-security
# ============================================================================

name: PR Security Check

on:
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'env/**'
      - 'modules/**'
      - '**.tf'
      - '**.tfvars'
  
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to scan'
        required: true
        type: choice
        options:
          - dev
          - stage
          - prod
        default: 'dev'
      severity:
        description: 'Minimum severity to fail on'
        required: false
        type: choice
        options:
          - LOW
          - MEDIUM
          - HIGH
          - CRITICAL
        default: 'HIGH'
      block-on-failure:
        description: 'Block PR merge on security failures'
        required: false
        type: boolean
        default: false

# Prevent concurrent runs for the same PR
concurrency:
  group: pr-security-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

# Minimal permissions (principle of least privilege)
permissions:
  contents: read
  pull-requests: write
  security-events: write
  id-token: write      # Required for Azure OIDC authentication

jobs:
  # ==========================================================================
  # Job 1: PREPARE - Environment Detection
  # ==========================================================================
  prepare:
    name: Detect Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.env.outputs.environment }}
      working-directory: ${{ steps.env.outputs.working-directory }}
      changed-paths: ${{ steps.env.outputs.changed-paths }}
      detection-method: ${{ steps.env.outputs.detection-method }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
        with:
          fetch-depth: 0  # Required for path filtering
      
      - name: Detect Environment
        id: env
        uses: paloitmbb/mbb-tf-actions/actions/determine-environment@main
        with:
          manual-environment: ${{ inputs.environment || '' }}
          base-ref: ${{ github.base_ref || 'main' }}
      
      - name: Display Detection Results
        run: |
          echo "ğŸ” Environment Detection Results"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Environment: ${{ steps.env.outputs.environment }}"
          echo "Working Directory: ${{ steps.env.outputs.working-directory }}"
          echo "Detection Method: ${{ steps.env.outputs.detection-method }}"
          echo "Changed Paths: ${{ steps.env.outputs.changed-paths }}"

  # ==========================================================================
  # Job 2: VALIDATE-AND-SCAN - Security Validation (terraform-security.yml)
  # ==========================================================================
  validate-and-scan:
    name: Validate & Scan (${{ needs.prepare.outputs.environment }})
    needs: prepare
    permissions:
      contents: read
      security-events: write
      actions: read
      id-token: write      # Required for Azure OIDC authentication
    uses: paloitmbb/mbb-tf-workflows/.github/workflows/terraform-security.yml@main
    with:
      terraform-version: '1.7.0'
      working-directory: ${{ needs.prepare.outputs.working-directory }}
      environment: ${{ needs.prepare.outputs.environment }}
      
      # Enable all security scanners
      enable-tfsec: true
      enable-checkov: true
      enable-trivy: true
      enable-tflint: true
      
      # Configure severity thresholds
      tfsec-severity: ${{ inputs.severity || 'HIGH' }}
      checkov-severity: ${{ inputs.severity || 'HIGH' }}
      trivy-severity: ${{ inputs.severity || 'HIGH' }}
      
      # Continue-on-error Control (allow all scans to run for comprehensive reporting)
      tfsec-continue-on-error: true
      checkov-continue-on-error: true
      trivy-continue-on-error: true
      aggregate-continue-on-error: true  # Don't fail workflow, let security-gate handle it
      
      # Terraform configuration
      terraform-var-file: 'terraform.tfvars'
      runner-os: 'ubuntu-latest'
    
    secrets:
      # Azure OIDC Authentication for plan generation
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}


  # ==========================================================================
  # Job 3: SECURITY-GATE - Result Evaluation
  # ==========================================================================
  security-gate:
    name: Security Gate Evaluation
    needs: [prepare, validate-and-scan]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Evaluate Security Results
        id: evaluate
        run: |
          echo "ğŸš¦ Security Gate Evaluation"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Get security scan results
          ALL_PASSED="${{ needs.validate-and-scan.outputs.security-all-passed }}"
          TFSEC_STATUS="${{ needs.validate-and-scan.outputs.tfsec-status }}"
          CHECKOV_STATUS="${{ needs.validate-and-scan.outputs.checkov-status }}"
          TRIVY_STATUS="${{ needs.validate-and-scan.outputs.trivy-status }}"
          BLOCK_ON_FAILURE="${{ inputs.block-on-failure }}"
          
          # Default block-on-failure to true if not set (for PR triggers)
          if [ -z "$BLOCK_ON_FAILURE" ]; then
            BLOCK_ON_FAILURE="true"
          fi
          
          echo "ğŸ“Š Individual Scanner Results:"
          echo "   tfsec:   ${TFSEC_STATUS}"
          echo "   Checkov: ${CHECKOV_STATUS}"
          echo "   Trivy:   ${TRIVY_STATUS}"
          echo ""
          echo "Overall Result: ${ALL_PASSED}"
          echo "Block on Failure: ${BLOCK_ON_FAILURE}"
          echo ""
          
          # Determine exit strategy
          if [ "${ALL_PASSED}" == "true" ]; then
            echo "âœ… All security scans PASSED"
            echo "ğŸ”“ PR can be merged"
            exit 0
          else
            echo "âŒ One or more security scans FAILED"
            
            if [ "${BLOCK_ON_FAILURE}" == "true" ]; then
              echo "ğŸ”’ BLOCKING merge - Fix security issues before merging"
              echo "ğŸ“Š Review findings in Security tab: ${{ github.server_url }}/${{ github.repository }}/security/code-scanning"
              exit 1
            else
              echo "âš ï¸  REPORTING mode - Security issues detected but not blocking"
              echo "ğŸ“Š Review findings in Security tab: ${{ github.server_url }}/${{ github.repository }}/security/code-scanning"
              exit 0
            fi
          fi
      
      - name: Generate Security Summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ğŸ”’ Security Gate Results
          
          | Scanner | Status |
          |---------|--------|
          | **tfsec** | ${{ needs.validate-and-scan.outputs.tfsec-status == 'success' && 'âœ… Passed' || needs.validate-and-scan.outputs.tfsec-status == 'failure' && 'âŒ Failed' || 'â­ï¸ Skipped' }} |
          | **Checkov** | ${{ needs.validate-and-scan.outputs.checkov-status == 'success' && 'âœ… Passed' || needs.validate-and-scan.outputs.checkov-status == 'failure' && 'âŒ Failed' || 'â­ï¸ Skipped' }} |
          | **Trivy** | ${{ needs.validate-and-scan.outputs.trivy-status == 'success' && 'âœ… Passed' || needs.validate-and-scan.outputs.trivy-status == 'failure' && 'âŒ Failed' || 'â­ï¸ Skipped' }} |
          
          ### Overall Status
          
          ${{ needs.validate-and-scan.outputs.security-all-passed == 'true' && 'âœ… **All security scans PASSED**' || 'âŒ **Security issues detected**' }}
          
          ### ğŸ“Š Detailed Findings
          
          View detailed security findings in the [Security tab](${{ github.server_url }}/${{ github.repository }}/security/code-scanning).
          
          ### Configuration
          
          - **Environment**: `${{ needs.prepare.outputs.environment }}`
          - **Severity Threshold**: `${{ inputs.severity || 'HIGH' }}`
          - **Block on Failure**: `${{ inputs.block-on-failure || 'true' }}`
          
          EOF

  # ==========================================================================
  # Job 4: COMMENT-PR - PR Communication
  # ==========================================================================
  comment-pr:
    name: Comment Security Results
    needs: [prepare, validate-and-scan, security-gate]
    runs-on: ubuntu-latest
    if: always() && github.event_name == 'pull_request'
    permissions:
      pull-requests: write
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
      
      - name: Post Security Summary
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            // Helper functions
            const getStatusEmoji = (status) => {
              if (status === 'success') return 'âœ…';
              if (status === 'failure') return 'âŒ';
              return 'â­ï¸';
            };
            
            const getStatusText = (status) => {
              if (status === 'success') return 'Passed';
              if (status === 'failure') return 'Failed';
              return 'Skipped';
            };
            
            // Get job results
            const allPassed = '${{ needs.validate-and-scan.outputs.security-all-passed }}';
            const tfsecStatus = '${{ needs.validate-and-scan.outputs.tfsec-status }}';
            const checkovStatus = '${{ needs.validate-and-scan.outputs.checkov-status }}';
            const trivyStatus = '${{ needs.validate-and-scan.outputs.trivy-status }}';
            const tflintStatus = '${{ needs.validate-and-scan.outputs.tflint-status }}';
            const tfVersion = '${{ needs.validate-and-scan.outputs.terraform-version }}';
            
            // Environment detection results
            const environment = '${{ needs.prepare.outputs.environment }}';
            const workingDir = '${{ needs.prepare.outputs.working-directory }}';
            const detectionMethod = '${{ needs.prepare.outputs.detection-method }}';
            const changedPaths = '${{ needs.prepare.outputs.changed-paths }}';
            
            // Security gate result
            const gateStatus = '${{ needs.security-gate.result }}';
            const severityThreshold = '${{ inputs.severity || 'HIGH' }}';
            
            // Overall status
            const overallStatus = allPassed === 'true' ? 'âœ… PASSED' : 'âŒ FAILED';
            const overallEmoji = allPassed === 'true' ? 'ğŸ‰' : 'âš ï¸';
            
            // Build PR comment
            const body = `## ğŸ”’ PR Security Validation Results
            
            ${overallEmoji} **Overall Status: ${overallStatus}**
            
            ---
            
            ### ğŸ“‹ Environment & Configuration
            
            | Item | Value |
            |------|-------|
            | **Environment** | \`${environment}\` |
            | **Working Directory** | \`${workingDir}\` |
            | **Detection Method** | ${detectionMethod} |
            | **Terraform Version** | ${tfVersion} |
            | **Severity Threshold** | \`${severityThreshold}\` |
            
            ${changedPaths ? `**Changed Paths**: \`${changedPaths}\`` : ''}
            
            ---
            
            ### âœ… Validation Results
            
            | Check | Status |
            |-------|--------|
            | **terraform fmt** | ${getStatusEmoji(tflintStatus)} ${getStatusText(tflintStatus)} |
            | **terraform validate** | ${getStatusEmoji(tflintStatus)} ${getStatusText(tflintStatus)} |
            | **tflint** | ${getStatusEmoji(tflintStatus)} ${getStatusText(tflintStatus)} |
            
            ---
            
            ### ğŸ”’ Security Scan Results
            
            | Tool | Status | Description |
            |------|--------|-------------|
            | ğŸ” **tfsec** | ${getStatusEmoji(tfsecStatus)} ${getStatusText(tfsecStatus)} | Terraform static analysis security scanner |
            | ğŸ›¡ï¸ **Checkov** | ${getStatusEmoji(checkovStatus)} ${getStatusText(checkovStatus)} | Infrastructure as Code policy checks |
            | ğŸ” **Trivy** | ${getStatusEmoji(trivyStatus)} ${getStatusText(trivyStatus)} | Vulnerability and misconfiguration scanning |
            
            ${allPassed === 'true' 
              ? 'âœ… **All security checks passed!** This PR meets security requirements.' 
              : 'âŒ **Security issues detected!** Please review and fix before merging.'}
            
            ---
            
            <details>
            <summary>ğŸ“Š View Detailed Security Findings</summary>
            
            ### Where to find detailed results:
            
            1. **GitHub Security Tab**: [View Code Scanning Alerts â†’](${process.env.GITHUB_SERVER_URL}/${context.repo.owner}/${context.repo.repo}/security/code-scanning)
               - SARIF files from tfsec, Checkov, and Trivy are uploaded here
               - Filter by tool to see specific findings
               - Review severity levels and affected files
            
            2. **Workflow Run**: [View Workflow Logs â†’](${process.env.GITHUB_SERVER_URL}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
               - Check individual job logs for detailed scanner output
               - Review validation and security scan execution details
            
            3. **Job Summary**: Check the workflow summary for a quick overview
            
            ### Security Scanners:
            
            - ğŸ” **tfsec**: Terraform-specific static analysis for security misconfigurations
            - ğŸ›¡ï¸ **Checkov**: Policy-as-code with 500+ built-in checks for cloud best practices
            - ğŸ” **Trivy**: Comprehensive vulnerability scanner for IaC and dependencies
            
            ### Severity Threshold: \`${severityThreshold}\`
            
            Only findings at or above this severity level will cause failures.
            
            </details>`;
            
            // Post comment
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
            
            console.log('âœ… PR comment posted successfully');
